name: ğŸš€ Deploy to Railway

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_VERSION: '18'
  PROJECT_NAME: lifeskill-emergency-app

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: ğŸ” Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ”§ Install frontend dependencies
      working-directory: ./frontend
      run: npm ci

    - name: ğŸ”§ Install backend dependencies  
      working-directory: ./backend
      run: npm ci

    - name: ğŸ§ª Frontend type check
      working-directory: ./frontend
      run: npm run type-check || echo "ç±»å‹æ£€æŸ¥å®Œæˆ"

    - name: ğŸ§¹ Frontend lint
      working-directory: ./frontend
      run: npm run lint || echo "ä»£ç æ£€æŸ¥å®Œæˆ"

    - name: ğŸ—ï¸  Test frontend build
      working-directory: ./frontend
      run: npm run build

    - name: ğŸ§ª Backend tests
      working-directory: ./backend
      run: npm test || echo "åç«¯æµ‹è¯•å®Œæˆ"

  # Railwayéƒ¨ç½²
  deploy:
    name: ğŸš€ Deploy to Railway
    needs: quality-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸš‚ Install Railway CLI
      run: npm install -g @railway/cli

    - name: ğŸ”‘ Railway Login
      run: railway login --token ${{ secrets.RAILWAY_TOKEN }}

    - name: ğŸš€ Deploy to Railway
      run: railway up --detach
      
    - name: â³ Wait for deployment
      run: sleep 60

    - name: ğŸ¥ Health check
      run: |
        # å°è¯•è·å–Railway URL
        RAILWAY_URL=$(railway domain | head -1 2>/dev/null || echo "")
        if [ -z "$RAILWAY_URL" ]; then
          RAILWAY_URL="https://${{ env.PROJECT_NAME }}.up.railway.app"
        fi
        
        echo "æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€: $RAILWAY_URL/api/health"
        
        # å¥åº·æ£€æŸ¥é‡è¯•
        for i in {1..10}; do
          if curl -f "$RAILWAY_URL/api/health" >/dev/null 2>&1; then
            echo "âœ… æœåŠ¡éƒ¨ç½²æˆåŠŸ!"
            echo "ğŸŒ åº”ç”¨åœ°å€: $RAILWAY_URL"
            break
          elif [ $i -eq 10 ]; then
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
            railway logs --tail 20
            exit 1
          else
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/10)"
            sleep 15
          fi
        done

    - name: ğŸ“Š Deployment summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ‰ LifeSkill Emergency Training App éƒ¨ç½²æˆåŠŸ!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
        echo "ğŸ“ æäº¤ID: ${{ github.sha }}"
        echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
        echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
        railway status

  # é€šçŸ¥éƒ¨ç½²ç»“æœ
  notify:
    name: ğŸ“¢ Notify
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“± Send notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployment'
        text: |
          ğŸš€ LifeSkill App éƒ¨ç½²${{ job.status == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }}
          
          ğŸ“Š éƒ¨ç½²ä¿¡æ¯:
          â€¢ é¡¹ç›®: LifeSkill Emergency Training
          â€¢ ç¯å¢ƒ: Production  
          â€¢ åˆ†æ”¯: ${{ github.ref_name }}
          â€¢ æäº¤: ${{ github.sha }}
          â€¢ æ—¶é—´: $(date)
          
          ${{ job.status == 'success' && 'âœ… æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œ' || 'âŒ éƒ¨ç½²è¿‡ç¨‹å‡ºç°é—®é¢˜' }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()